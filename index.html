<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel de Pedidos - Mercatto Delivery</title>

<style>
:root{
  --bg:#0b0f19;
  --card:#151d2f;
  --text:#f8fafc;
  --muted:#94a3b8;
  --accent:#b8860b;
  --accent2:#ffcc70;
  --radius:14px;
  --shadow:0 6px 18px rgba(0,0,0,.4);
}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow-x:hidden;
}
header{
  text-align:center;
  padding:14px;
  background:linear-gradient(90deg,#000,#2a1c08);
  color:var(--accent2);
  font-size:20px;
  font-weight:600;
  letter-spacing:.3px;
  box-shadow:var(--shadow);
}
.container{
  max-width:1200px;
  margin:25px auto;
  padding:0 10px;
}
.filtro{
  display:flex;
  gap:10px;
  background:#1e293b;
  padding:10px;
  border-radius:var(--radius);
  align-items:center;
}
.filtro input{
  flex:1;
  background:none;
  border:none;
  color:#fff;
  outline:none;
  padding:10px;
  font-size:14px;
}
.filtro button{
  background:var(--accent);
  border:none;
  color:#000;
  font-weight:600;
  border-radius:8px;
  padding:8px 12px;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
th,td{
  padding:10px;
  text-align:left;
}
th{
  background:#1e2538;
  color:var(--accent2);
  position:sticky;
  top:0;
}
tr:nth-child(even){background:#121826;}
tr:hover{background:#1c2536;}
.status{
  padding:4px 8px;
  border-radius:8px;
  font-weight:600;
  text-transform:capitalize;
}
.status.Pendente{background:#444;color:#ffcc70;}
.status.Aceito{background:#166534;color:#fff;}
.status.Em\ rota{background:#2563eb;color:#fff;}
.status.Entregue{background:#15803d;color:#fff;}
.status.Cancelado{background:#7f1d1d;color:#fff;}
button.acao{
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:13px;
  cursor:pointer;
  transition:.2s;
}
button.acao:hover{
  background:var(--accent2);
}
@media(max-width:768px){
  th,td{font-size:12px;padding:8px;}
  .filtro{flex-direction:column;}
}
</style>
</head>
<body>
<header>üì¶ Painel de Pedidos - Mercatto Delivery</header>

<div class="container">
  <div class="filtro">
    <input id="busca" type="text" placeholder="Filtrar por cliente, bairro, status...">
    <button onclick="carregarPedidos()">üîÑ Atualizar</button>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Data</th>
        <th>Cliente</th>
        <th>Itens</th>
        <th>Total</th>
        <th>Pagamento</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="7" style="text-align:center;color:#aaa;">Carregando pedidos...</td></tr>
    </tbody>
  </table>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbznpq0NwLgqMv31TbFM7HyFzIEHE8ccmon1n1b4N6S3EtOBFr0DxwssBP5_0qZa9tB7/exec";

let todosPedidos = [];

async function carregarPedidos(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#aaa;">‚è≥ Carregando...</td></tr>`;
  try{
    const resp = await fetch(ENDPOINT+"?acao=lerPedidos");
    const dados = await resp.json();
    todosPedidos = dados.pedidos || [];
    renderTabela(todosPedidos);
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#fca5a5;">Erro ao carregar pedidos</td></tr>`;
  }
}

function renderTabela(lista){
  const tbody=document.getElementById('tbody');
  if(!lista.length){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;color:#aaa;">Nenhum pedido encontrado</td></tr>`;
    return;
  }
  tbody.innerHTML=lista.map(p=>{
    const total = Number(p.Total||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const itens = (p.Itens||'').split(',').slice(0,2).join(', ') + (p.Itens?.split(',').length>2?'...':'');
    const status = p.Status||'Pendente';
    return `
      <tr>
        <td>${formatarData(p["Data/Hora"])}</td>
        <td>${p.Nome||'-'}<br><small>${p.Bairro||''}</small></td>
        <td>${itens}</td>
        <td>${total}</td>
        <td>${p["Forma de Pagamento"]||''}</td>
        <td><span class="status ${status.replace(' ','_')}">${status}</span></td>
<td>
  <button class="acao" onclick="mudarStatus('${p.ID}','Aceito')">Aceitar</button>
  <button class="acao" onclick="mudarStatus('${p.ID}','Saiu para entrega')">Saiu p/ entrega</button>
  <button class="acao" style="background:#7f1d1d;color:#fff;" onclick="mudarStatus('${p.ID}','Cancelado')">Cancelar</button>
</td>

      </tr>`;
  }).join('');
}

function formatarData(d){
  if(!d) return '';
  try{
    return new Date(d).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
  }catch{return d;}
}

async function mudarStatus(id,novo){
  const confirmacao = confirm(`Confirmar mudan√ßa de status para "${novo}"?`);
  if(!confirmacao) return;
  try{
    const body = {acao:"atualizarStatus",id,novoStatus:novo};
    const r = await fetch(ENDPOINT,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const resp = await r.json();
    alert(resp.mensagem||"Status atualizado!");
    carregarPedidos();
  }catch(e){
    alert("Erro ao atualizar status.");
  }
}

document.getElementById('busca').addEventListener('input',()=>{
  const termo = document.getElementById('busca').value.toLowerCase();
  const filtrados = todosPedidos.filter(p=>
    (p.Nome||'').toLowerCase().includes(termo) ||
    (p.Bairro||'').toLowerCase().includes(termo) ||
    (p.Status||'').toLowerCase().includes(termo)
  );
  renderTabela(filtrados);
});

carregarPedidos();
</script>
</body>
</html>
